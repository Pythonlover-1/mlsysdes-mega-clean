# Diagram-to-CSV Service — описание системы

## Основные компоненты

| Компонент | Технология | Роль |
|-----------|-----------|------|
| **UI** | React + Vite + Tailwind | Загрузка изображения, отображение результата (таблица, raw CSV, превью), история конвертаций |
| **API** | FastAPI (Python) | `POST /api/convert` — принимает изображение, возвращает граф + CSV |
| **ML/CV пайплайн** | PyTorch + torchvision + HuggingFace weights | Детекция BPMN-элементов (объекты) и связей (стрелки с keypoints) |
| **OCR** | Tesseract (`pytesseract`) | Извлечение текста из найденных элементов (eng+rus) |
| **Сборка графа** | Python | Восстановление узлов/рёбер и контейнеров (lane/pool), экспорт в CSV |
| **Хранилище** | localStorage (браузер) | История конвертаций (до 50 записей) — CSV + превью изображения |

## Поток данных

```
Пользователь                UI (React)                  API (FastAPI)                 ML/CV + OCR
    │                          │                              │                           │
    │──── drag & drop ────────>│                              │                           │
    │     изображение          │                              │                           │
    │                          │── POST /api/convert ────────>│                           │
    │                          │   multipart/form-data        │                           │
    │                          │                              │── детекция (объекты) ────>│
    │                          │                              │── детекция (стрелки) ────>│
    │                          │                              │── OCR подписи ───────────>│
    │                          │                              │── сборка графа ──────────>│
    │                          │<── { graph, csv, ... } ──────│                           │
    │<── таблица + raw CSV ────│                              │                           │
    │    + сохранение в        │                              │                           │
    │      localStorage        │                              │                           │
```

**Вход:** изображение BPMN-диаграммы (поддерживаются lane/pool, задачи, события, шлюзы, стрелки/flows).

**Обработка:**
1. Фронтенд читает файл, отправляет как `multipart/form-data` на `/api/convert`
2. Бэкенд запускает детекцию BPMN-объектов и стрелок (модели PyTorch, веса из HuggingFace)
3. Для найденных элементов выполняется OCR (Tesseract) для извлечения подписей
4. По геометрии bounding boxes и keypoints восстанавливаются связи и собирается граф (nodes/edges/lanes)
5. Граф экспортируется в CSV (список рёбер + атрибуты источника/цели)

**Выход:** JSON с полями (ключевые):
- `csv`: CSV-строка
- `graph`: структурированное представление (nodes/edges/lanes)
- `filename`, `image_size`, `processing_time_ms`

## Где используется ML/CV

Пайплайн целиком локальный (внутри `backend`) и состоит из:
- **Детектор объектов**: Faster R-CNN (BPMN элементы)
- **Детектор стрелок**: Keypoint R-CNN (flows с keypoints направления)
- **OCR**: Tesseract через `pytesseract` (языки по умолчанию `eng+rus`)
- **Сборка графа**: геометрические эвристики (ближайшие узлы к keypoints, fallback по bbox)

Кодовые точки входа:
- API: `backend/app/main.py`
- Детекция: `backend/app/services/bpmn_detector.py`
- Сборка графа + OCR: `backend/app/services/bpmn_graph.py`

## Развёртывание

- **Docker Compose** — два контейнера:
  - `backend` — Python/uvicorn на порту 8000
  - `frontend` — multi-stage build (Node → nginx) на порту 3000, nginx проксирует `/api` на backend
- **CPU only** — используется CPU-версия PyTorch; веса моделей предскачиваются на этапе сборки образа (`backend/Dockerfile`)
- Запуск: `docker compose up --build`

Демо (если развернуто отдельно): `http://158.160.99.112:3001/`

---

## Направления развития

Текущий подход — CV пайплайн (детекция + OCR + сборка графа). Дальше можно развивать в нескольких направлениях:

### 1. Улучшение CV-пайплайна

- Улучшить восстановление связей стрелок (полилинии/изломы, пересечения, направление)
- Улучшить OCR (автоподбор препроцессинга, словари предметной области)
- Добавить пост-валидацию графа (по правилам BPMN) и интерактивные правки

### 2. Гибридный подход: CV + LLM (опционально)

- CV извлекает структуру (узлы/стрелки/текст), LLM помогает нормализовать названия/типы и формировать “человекочитаемые” таблицы
- LLM также можно использовать для исправления ошибок OCR и дедупликации

### 3. Обучение/замена детекторов

- Собрать/разметить датасет диаграмм под целевые типы элементов
- Заменить детекторы на более быстрые (например, YOLO-подобные) или дообучить текущие
